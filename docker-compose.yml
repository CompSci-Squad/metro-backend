version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:14-alpine
    container_name: construction-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: construction_monitoring
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/001_create_tables.sql:/docker-entrypoint-initdb.d/001_create_tables.sql
    networks:
      - construction-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d construction_monitoring"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # LocalStack (AWS S3 emulator)
  localstack:
    image: localstack/localstack:latest
    container_name: construction-localstack
    restart: unless-stopped
    ports:
      - "4566:4566"
    environment:
      SERVICES: s3
      DEBUG: 0
      PERSISTENCE: 1
      SKIP_INFRA_DOWNLOADS: 1
      EDGE_PORT: 4566
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - construction-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Backend API
  # backend:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: construction-backend
  #   restart: unless-stopped
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     # Database
  #     DB_HOST: postgres
  #     DB_PORT: 5432
  #     DB_NAME: construction_monitoring
  #     DB_USER: postgres
  #     DB_PASSWORD: postgres123
      
  #     # AWS S3 (LocalStack)
  #     AWS_ACCESS_KEY_ID: test
  #     AWS_SECRET_ACCESS_KEY: test
  #     AWS_REGION: us-east-1
  #     AWS_ENDPOINT: http://localstack:4566
  #     S3_BUCKET_NAME: construction-monitoring-bucket
      
  #     # VIRAG-BIM API (configure with your ngrok URL)
  #     NGROK_URL: ${NGROK_URL:-https://your-ngrok-url.ngrok-free.app}
  #     VIRAG_API_KEY: ${VIRAG_API_KEY:-your_api_key}
      
  #     # Server
  #     PORT: 3000
  #     NODE_ENV: production
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     localstack:
  #       condition: service_healthy
  #   networks:
  #     - construction-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
  #     interval: 15s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 60s
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

  # AWS CLI for LocalStack initialization
  localstack-init:
    image: amazon/aws-cli
    container_name: construction-localstack-init
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: /bin/sh
    command: >
      -c "
      echo '==========================================';
      echo '‚òÅÔ∏è  Inicializando LocalStack S3...';
      echo '==========================================';
      sleep 5;
      echo '';
      echo 'üì¶ Criando bucket S3...';
      if aws --endpoint-url=http://localstack:4566 s3 mb s3://construction-monitoring-bucket 2>/dev/null; then
        echo '‚úÖ Bucket criado com sucesso!';
      else
        echo '‚ö†Ô∏è  Bucket j√° existe (ok)';
      fi;
      echo '';
      echo 'üìã Listando buckets dispon√≠veis:';
      aws --endpoint-url=http://localstack:4566 s3 ls;
      echo '';
      echo '==========================================';
      echo '‚úÖ LocalStack inicializado com sucesso!';
      echo '==========================================';
      "
    networks:
      - construction-network
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  construction-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  localstack_data:
    driver: local
